{{ $gallery := "" }}

{{ $images := slice }}
{{ $captionizedImages := slice }}
{{ if eq .Kind "term" }}
  {{ range .Pages }}
    {{ $bundledImages := .Resources.ByType "image" }}
    {{ $lengthOfBunIm := ($bundledImages | len) }}
    {{ $images = $images | append ($bundledImages) }}
  {{ end }}
{{ else }}
  {{ $bundledImages := .Resources.ByType "image" }}
  {{ $lengthOfBunIm := ($bundledImages | len) }}
    {{ range $bundledImages }}
      {{ $images = $images | append . }}
      {{ $captionizedImages = $captionizedImages | append .RelPermalink }}
    {{ end }}
{{ end }}

{{ with $images }}
  {{ $id := $.RelPermalink | hash.FNV32a }}
  {{ $idx :=  mod $id (len $images) }}
  {{ $first := index $images $idx }}
  {{ $thumb := $first.Fill "400x264 smart" }}
  {{ $gallery = dict
    "page" $
    "images" $images
    "thumb" $thumb
    "captionsforimages" $captionizedImages
  }}
{{ end }}
{{ return $gallery }}